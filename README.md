# Operations

## 1. Running Agency


### Cancel old pending jobs at the starting of a new day.

Perform this task daily, until we develop ["prioritize newer" parameter to the rules engine](https://github.com/MassProspecting/docs/issues/336).

```sql
-- Cancel old pending jobs at the starting of a new day.
--
update "enrichment" set status=5 where status=0;
update "outreach" set status=5 where status=0;
```

### Cancel old failed jobs at the starting of a new day.

```sql
-- Cancel old failed jobs at the starting of a new day.
--
update "job" set status=5 where status=3;
update "inboxcheck" set status=5 where status=3;
update "connectioncheck" set status=5 where status=3;
update "enrichment" set status=5 where status=3;
update "outreach" set status=5 where status=3;
```

### Cancel jobs that started time ago and never finished.

```sql
-- Cancel jobs that started time ago and never finished.
--
update "enrichment" set status=0 where status=1 and update_time<current_timestamp - interval '45 minutes';
update "outreach" set status=0 where status=1 and update_time<current_timestamp - interval '45 minutes';
```

### Add the `target` tag to enriched leads.

Run the `insert` setnences generated by the query below.

```sql
-- Enriched leads to add the `target` tag.
--
select '
	insert into lead_tag (id, id_account, create_time, update_time, id_lead, id_tag) values (
		uuid_generate_v4(),
		''87a65cf4-c11d-4700-b266-58361ca14b8e'', -- my-agency
		current_timestamp,
		current_timestamp,
		'''||cast(e.id_lead as varchar(500))||''',
		''d94f69a1-1ef1-417c-bac2-ff0f2921f1f8'' -- target
	);	
', e.done_time, l.first_name, l.last_name, l.job_title, h."name", y.name
from enrichment e
join rule_instance i on (i.id=e.id_rule_instance and i.id_rule='0968b2ee-3998-49e4-b2fc-b3ca28dbe5e8')
join "lead" l on l.id=e.id_lead
join "company" c on c.id=l.id_company
left join headcount h on h.id=c.id_headcount 
left join country y on y.id=c.id_country 
where l.id not in (
	select x.id_lead
	from lead_tag x
	where x.id_tag='d94f69a1-1ef1-417c-bac2-ff0f2921f1f8' -- target
)
and e.done_time > current_timestamp - interval '24 hours' -- prioritize recent enrichments 
and y.name = 'United States'
and h.min >= 4
and (
	l.job_title ilike '%owner%' or
	l.job_title ilike '%CEO%' or
	l.job_title ilike '%founder%' or
	l.job_title ilike '%president%'
)
order by e.done_time desc
```

### Verified emails to export to Instanctly.

_pending_